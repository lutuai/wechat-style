# 技术架构方案

## 一、技术栈选择

### 前端技术栈
```
框架：React 18 + TypeScript
状态管理：Zustand / Jotai
UI组件：Ant Design / Shadcn/ui
样式方案：TailwindCSS + CSS Modules
编辑器：Monaco Editor / TipTap
图表：ECharts / Recharts
构建工具：Vite
```

### 后端技术栈
```
语言：Node.js + TypeScript / Python + FastAPI
框架：Express / Fastify / FastAPI
数据库：PostgreSQL 15+
缓存：Redis 7+
对象存储：阿里云OSS / 腾讯云COS
搜索引擎：Elasticsearch（可选）
```

### AI集成
```
LLM：Claude API / OpenAI API
图片生成：Stable Diffusion / Midjourney API
```

---

## 二、系统架构图

```
┌─────────────────────────────────────────────────────┐
│                     用户层                          │
│  Web端 │ 移动端H5 │ 浏览器插件 │ 微信小程序         │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│                   前端应用层                        │
│  React App + 静态资源托管 (Vercel/阿里云OSS)         │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│                   API网关层                         │
│  Nginx / Kong (负载均衡、限流、鉴权)                │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│                   业务服务层                        │
├──────────────┬──────────────┬──────────────────────┤
│  用户服务    │  内容服务    │  AI服务              │
│  - 认证授权  │  - 文章管理  │  - 智能排版          │
│  - 用户管理  │  - 模板管理  │  - 内容优化          │
│              │              │  - 标题生成          │
├──────────────┼──────────────┼──────────────────────┤
│  模板服务    │  样式服务    │  导出服务            │
│  - 模板CRUD  │  - 配色方案  │  - HTML生成          │
│  - 模板市场  │  - 样式预设  │  - 图片导出          │
└──────────────┴──────────────┴──────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│                   数据存储层                        │
├──────────────┬──────────────┬──────────────────────┤
│  PostgreSQL  │  Redis       │  对象存储            │
│  - 用户数据  │  - 缓存      │  - 模板预览图        │
│  - 内容数据  │  - 会话      │  - 用户上传图片      │
│  - 模板数据  │  - 排队      │                      │
└──────────────┴──────────────┴──────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│                   外部服务集成                      │
│  微信公众号API │ OpenAI │ 阿里云OSS │ 邮件服务    │
└─────────────────────────────────────────────────────┘
```

---

## 三、数据库设计

### 3.1 核心表结构

**用户表 (users)**
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  avatar_url VARCHAR(500),
  subscription_type VARCHAR(20) DEFAULT 'free', -- free/pro/enterprise
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_subscription ON users(subscription_type);
```

**模板表 (templates)**
```sql
CREATE TABLE templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  description TEXT,
  category VARCHAR(50) NOT NULL, -- minimal/business/lively/premium
  style_type VARCHAR(50), -- tutorial/analysis/review/news
  thumbnail_url VARCHAR(500),
  preview_html TEXT,
  is_official BOOLEAN DEFAULT false,
  is_public BOOLEAN DEFAULT true,
  creator_id UUID REFERENCES users(id),
  usage_count INTEGER DEFAULT 0,
  rating DECIMAL(3,2),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_templates_category ON templates(category);
CREATE INDEX idx_templates_style ON templates(style_type);
CREATE INDEX idx_templates_creator ON templates(creator_id);
```

**文章表 (articles)**
```sql
CREATE TABLE articles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  template_id UUID REFERENCES templates(id),
  title VARCHAR(200),
  content JSONB, -- 存储文章内容和结构
  style_config JSONB, -- 存储样式配置
  preview_url VARCHAR(500),
  html_content TEXT,
  status VARCHAR(20) DEFAULT 'draft', -- draft/published/archived
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_articles_user ON articles(user_id);
CREATE INDEX idx_articles_status ON articles(status);
CREATE INDEX idx_articles_created ON articles(created_at DESC);
```

**配色方案表 (color_schemes)**
```sql
CREATE TABLE color_schemes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  primary_color VARCHAR(7) NOT NULL,
  secondary_color VARCHAR(7),
  accent_color VARCHAR(7),
  background_color VARCHAR(7),
  text_color VARCHAR(7),
  is_preset BOOLEAN DEFAULT true,
  user_id UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**使用统计表 (usage_stats)**
```sql
CREATE TABLE usage_stats (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  event_type VARCHAR(50) NOT NULL, -- template_use/export/login
  resource_id UUID,
  metadata JSONB,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_stats_user ON usage_stats(user_id);
CREATE INDEX idx_stats_event ON usage_stats(event_type);
CREATE INDEX idx_stats_created ON usage_stats(created_at DESC);
```

---

## 四、核心功能实现方案

### 4.1 Markdown编辑器
**技术选择**：Monaco Editor（VS Code同款）

**核心功能**：
- 实时预览（左右分栏）
- 语法高亮
- 快捷键支持
- 图片上传（粘贴即传）
- 自动保存（防丢失）

### 4.2 模板引擎
**实现方案**：
```javascript
// 模板渲染引擎伪代码
class TemplateEngine {
  render(content, template, styleConfig) {
    // 1. 解析内容结构
    const structure = this.parseContent(content);

    // 2. 应用模板样式
    const styled = this.applyTemplate(structure, template);

    // 3. 应用自定义样式
    const customized = this.applyCustomStyles(styled, styleConfig);

    // 4. 生成最终HTML
    return this.generateHTML(customized);
  }
}
```

### 4.3 AI智能排版
**技术方案**：
```python
# AI排版建议服务
from openai import OpenAI

class AIStylist:
    def suggest_layout(self, content, content_type):
        """
        根据内容类型推荐最佳排版方案
        """
        prompt = f"""
        分析以下{content_type}类型的内容，推荐最佳排版方案：

        内容：{content}

        请返回：
        1. 推荐模板ID
        2. 配色建议
        3. 重点标注建议
        """

        response = self.client.chat.completions.create(
            model="claude-3-5-sonnet-20241022",
            messages=[{"role": "user", "content": prompt}]
        )

        return self.parse_response(response)
```

### 4.4 微信公众号集成
**实现方案**：
```javascript
// 微信公众号API封装
class WeChatPublisher {
  async publish(article) {
    // 1. 生成草稿
    const draft = await this.createDraft(article);

    // 2. 上传图片素材
    const mediaIds = await this.uploadImages(article.images);

    // 3. 发布文章
    return await this.publishToMP(draft, mediaIds);
  }

  // 备选方案：生成可复制格式
  async generateCopyFormat(article) {
    return {
      html: article.html,
      richText: this.generateRichText(article),
      markdown: article.markdown
    };
  }
}
```

---

## 五、性能优化方案

### 5.1 前端优化
- 代码分割
- 懒加载
- 图片压缩
- CDN加速

### 5.2 后端优化
- 数据库索引优化
- Redis缓存热点数据
- 异步任务队列
- 静态资源CDN

### 5.3 加载优化策略
```
首屏加载 < 2秒
模板渲染 < 500ms
AI响应 < 5秒
导出HTML < 1秒
```

---

## 六、安全方案

### 6.1 认证授权
- JWT Token认证
- OAuth 2.0（微信登录）
- RBAC权限控制

### 6.2 数据安全
- HTTPS加密传输
- 密码bcrypt加密
- SQL注入防护
- XSS防护

### 6.3 内容安全
- 内容过滤（敏感词）
- 图片审核（阿里云内容安全）
- 防爬虫策略

---

## 七、部署方案

### 7.1 开发环境
```yaml
docker-compose.yml:
  - frontend: React (Vite dev server)
  - backend: Node.js (hot reload)
  - postgres: PostgreSQL 15
  - redis: Redis 7
```

### 7.2 生产环境
```
前端：Vercel / 阿里云OSS + CDN
后端：阿里云ECS / 腾讯云CVM
数据库：阿里云RDS PostgreSQL
缓存：阿里云Redis
```

---

## 八、监控与运维

### 8.1 日志系统
- Winston（Node.js）/ Python Logging
- ELK Stack（日志分析）
- Sentry（错误追踪）

### 8.2 性能监控
- Grafana（可视化监控）
- Prometheus（指标收集）
- 阿里云云监控

---

## 九、开发时间线

**第1周**：项目搭建 + 数据库设计
**第2周**：核心编辑器开发
**第3周**：模板引擎开发
**第4周**：AI集成 + 测试
**第5周**：上线部署 + 运营准备

---

## 十、技术风险与应对

| 风险 | 概率 | 影响 | 应对方案 |
|------|------|------|---------|
| 微信API限制 | 中 | 高 | 提供多种发布方式 |
| AI成本过高 | 中 | 中 | 请求缓存 + 批量处理 |
| 并发性能瓶颈 | 低 | 高 | 负载均衡 + 缓存 |
| 模板版权问题 | 低 | 中 | 用户协议 + 审核 |

---

**文档版本**：v1.0
**最后更新**：2026-02-06
**架构师**：Claude
**状态**：待评审
